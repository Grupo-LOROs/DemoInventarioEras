<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inventario Renovables (Plain v2)</title>
  <style>
    :root { --bg:#f8fafc; --fg:#0f172a; --muted:#475569; --card:#ffffff; --border:#e2e8f0; --btn:#0f172a; --btnfg:#ffffff; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    header { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:16px 20px; max-width:1200px; margin:0 auto; }
    .title { font-weight:600; font-size:18px; }
    .bar { display:flex; gap:8px; }
    button, .btn { border:1px solid var(--border); background:#fff; color:var(--fg); padding:8px 12px; border-radius:10px; cursor:pointer; }
    .btn-primary { background:var(--btn); color:var(--btnfg); border:none; }
    .container { max-width:1200px; padding:8px 20px 24px; margin:0 auto; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    input, select { border:1px solid var(--border); border-radius:8px; padding:8px 10px; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { padding:10px; border-bottom:1px solid var(--border); text-align:left; }
    th.right, td.right { text-align:right; }
    th.sort { cursor:pointer; user-select:none; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .muted { color:var(--muted); font-size:12px; }
    .mt-8 { margin-top:16px; }
    .mt-16 { margin-top:24px; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; }
    /* Ensure hidden always wins over display:flex above */
    .hidden { display:none !important; }
    .modal { background:#fff; border-radius:16px; padding:16px; width:min(600px, calc(100% - 24px)); }
    .grow { flex:1; }
    .tabs { display:flex; gap:8px; margin-bottom:12px; }
    .tabs button[aria-selected="true"] { background:var(--btn); color:#fff; border-color:var(--btn); }
    .actions { display:flex; gap:6px; }
  </style>
</head>
<body>
  <header>
    <div class="title"> Inventario Renovables</div>
    <div class="bar">
      <div class="tabs">
        <button id="tab-products" aria-selected="true">Productos</button>
        <button id="tab-discrepancies" aria-selected="false">Discrepancias</button>
      </div>
      <button id="btn-config">Configurar API</button>
      <button id="btn-logout">Salir</button>
    </div>
  </header>

  <div class="container">
    <div id="auth-card" class="card mt-8 hidden">
      <div style="font-weight:600; margin-bottom:10px;">Iniciar sesi贸n</div>
      <div class="row">
        <input id="email" placeholder="Email" class="grow">
        <input id="password" type="password" placeholder="Contrase帽a" class="grow">
        <button id="btn-login" class="btn-primary">Entrar</button>
      </div>
      <div class="muted mt-8">Tip: Reg铆strate primero con rol admin desde /auth/register en el API.</div>
    </div>

    <div id="products-card" class="card mt-8">
      <div class="row" style="margin-bottom:10px;">
        <input id="q" placeholder="Buscar por c贸digo o descripci贸n" class="grow">
        <select id="type"></select>
        <select id="limit">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
        </select>
        <button id="btn-export-products">Exportar CSV</button>
      </div>
      <div class="muted" id="api-info"></div>
      <div class="mt-8">
        <table>
          <thead>
            <tr>
              <th class="sort" data-col="id_code">C贸digo</th>
              <th class="sort" data-col="description">Descripci贸n</th>
              <th class="right sort" data-col="stock">Stock</th>
              <th class="right sort" data-col="unit_cost">Costo</th>
              <th class="right sort" data-col="valuation">Valuaci贸n</th>
              <th class="sort" data-col="product_type">Tipo</th>
              <th>Pol铆tica</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody-products"></tbody>
        </table>
        <div class="row mt-8" style="justify-content:space-between;">
          <div class="actions">
            <button id="prev">Anterior</button>
            <button id="next">Siguiente</button>
          </div>
          <div class="muted" id="page-info"></div>
        </div>
      </div>
    </div>

    <div id="discrepancies-card" class="card mt-8 hidden">
      <div class="row" style="justify-content:space-between; margin-bottom:10px;">
        <div style="font-weight:600;">Discrepancias detectadas</div>
        <a id="export-discrepancies" class="btn" href="#" target="_blank" rel="noreferrer">Exportar CSV</a>
      </div>
      <table>
        <thead>
          <tr>
            <th>C贸digo</th>
            <th>Descripci贸n</th>
            <th>Tipo</th>
            <th>Detalle</th>
            <th class="right">Stock</th>
            <th class="right">Costo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody-discrepancies"></tbody>
      </table>
    </div>
  </div>

  <!-- Edit modal -->
  <div id="modal-backdrop" class="modal-backdrop hidden">
    <div class="modal">
      <div style="font-weight:600; margin-bottom:10px;">Editar producto</div>
      <div class="row">
        <div class="grow">
          <div class="muted">C贸digo</div>
          <div id="m-code" class="mono"></div>
        </div>
      </div>
      <div class="row mt-8">
        <div class="grow">
          <div class="muted">Descripci贸n</div>
          <input id="m-description" class="grow">
        </div>
      </div>
      <div class="row mt-8">
        <div>
          <div class="muted">Costo Unit.</div>
          <input id="m-unit-cost" type="number" step="0.01">
        </div>
        <div>
          <div class="muted">Min Stock</div>
          <input id="m-min" type="number">
        </div>
        <div>
          <div class="muted">Max Stock</div>
          <input id="m-max" type="number">
        </div>
      </div>
      <div class="row mt-8" style="justify-content:flex-end;">
        <button id="m-cancel">Cancelar</button>
        <button id="m-save" class="btn-primary">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // --- State ---
    const state = {
      apiBase: localStorage.getItem('apiBase') || 'http://127.0.0.1:8000',
      token: localStorage.getItem('jwt') || '',
      products: [],
      types: [],
      q: '',
      typeId: '',
      limit: 50,
      offset: 0,
      sort: 'id_code',
      order: 'asc',
      selected: null,
    };

    // --- Helpers ---
    const $ = (id) => document.getElementById(id);
    const show = (el, vis=true) => el.classList[vis ? 'remove' : 'add']('hidden');
    const fmt = (n) => (n==null ? '' : Number(n).toLocaleString());

    const authedFetch = (path, opts={}) => {
      return fetch(state.apiBase + path, {
        ...opts,
        headers: {
          'Content-Type': 'application/json',
          ...(opts.headers||{}),
          ...(state.token ? {'Authorization': 'Bearer ' + state.token} : {}),
        }
      });
    };

    // Ensure modal is hidden on load (belt and suspenders)
    document.addEventListener('DOMContentLoaded', () => {
      const mb = $('modal-backdrop');
      if (mb) { show(mb, false); }
    });

    // --- Auth / UI init ---
    function updateAuthUI(){
      $('api-info').textContent = 'API: ' + state.apiBase + (state.token ? ' | Autenticado' : ' | Invitado');
      show($('auth-card'), !state.token);
    }

    // --- Config API ---
    $('btn-config').onclick = () => {
      const url = prompt('Base URL del API:', state.apiBase);
      if(url){
        state.apiBase = url;
        localStorage.setItem('apiBase', url);
        updateAuthUI();
        loadTypes();
        loadProducts();
        loadDiscrepancies();
      }
    };

    // --- Tabs ---
    $('tab-products').onclick = () => {
      $('tab-products').setAttribute('aria-selected','true');
      $('tab-discrepancies').setAttribute('aria-selected','false');
      show($('products-card'), true);
      show($('discrepancies-card'), false);
    };
    $('tab-discrepancies').onclick = () => {
      $('tab-products').setAttribute('aria-selected','false');
      $('tab-discrepancies').setAttribute('aria-selected','true');
      show($('products-card'), false);
      show($('discrepancies-card'), true);
    };

    // --- Login / Logout ---
    $('btn-login').onclick = async () => {
      const body = new URLSearchParams({username: $('email').value, password: $('password').value});
      const res = await fetch(state.apiBase + '/auth/login', {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body
      });
      if(!res.ok){ alert('Credenciales inv谩lidas'); return; }
      const data = await res.json();
      state.token = data.access_token;
      localStorage.setItem('jwt', state.token);
      updateAuthUI();
    };

    $('btn-logout').onclick = () => {
      state.token = '';
      localStorage.removeItem('jwt');
      updateAuthUI();
    };

    // --- Products ---
    async function loadTypes(){
      const res = await fetch(state.apiBase + '/types');
      if(!res.ok) return;
      state.types = await res.json();
      const sel = $('type');
      sel.innerHTML = '<option value="">Todos los tipos</option>' + state.types.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
    }

    async function loadProducts(){
      const url = new URL(state.apiBase + '/products_full');
      if(state.q) url.searchParams.set('q', state.q);
      if(state.typeId) url.searchParams.set('type_id', state.typeId);
      url.searchParams.set('limit', state.limit);
      url.searchParams.set('offset', state.offset);
      url.searchParams.set('sort', state.sort);
      url.searchParams.set('order', state.order);
      const res = await fetch(url.toString());
      if(!res.ok){ $('tbody-products').innerHTML = '<tr><td colspan="8">Error cargando productos</td></tr>'; return; }
      state.products = await res.json();
      renderProducts();
    }

    function renderProducts(){
      const tbody = $('tbody-products');
      tbody.innerHTML = state.products.map(r=>`
        <tr>
          <td class="mono">${r.id_code}</td>
          <td>${r.description}</td>
          <td class="right">${fmt(r.stock)}</td>
          <td class="right">${fmt(r.unit_cost ?? 0)}</td>
          <td class="right">${fmt(r.valuation ?? 0)}</td>
          <td>${r.product_type ?? ''}</td>
          <td class="muted">Min ${r.min_stock ?? '-'} 路 Max ${r.max_stock ?? '-'}</td>
          <td class="actions">
            <button data-action="edit" data-id="${r.id}">Editar</button>
            <button data-action="history" data-id="${r.id}">Historial</button>
          </td>
        </tr>
      `).join('');

      // bind actions
      tbody.querySelectorAll('button[data-action="edit"]').forEach(btn=>{
        btn.onclick = () => openEdit(Number(btn.dataset.id));
      });
      tbody.querySelectorAll('button[data-action="history"]').forEach(btn=>{
        btn.onclick = () => showHistory(Number(btn.dataset.id));
      });

      $('page-info').textContent = `Mostrando ${state.products.length} elementos (offset ${state.offset})`;
    }

    // Sorting
    document.querySelectorAll('th.sort').forEach(th => {
      th.onclick = () => {
        const col = th.dataset.col;
        if(state.sort === col) state.order = state.order === 'asc' ? 'desc' : 'asc';
        else { state.sort = col; state.order = 'asc'; }
        loadProducts();
      };
    });

    $('prev').onclick = () => { state.offset = Math.max(0, state.offset - state.limit); loadProducts(); };
    $('next').onclick = () => { state.offset += state.limit; loadProducts(); };
    $('limit').onchange = () => { state.limit = Number($('limit').value); state.offset = 0; loadProducts(); };
    $('q').oninput = () => { state.q = $('q').value; state.offset = 0; loadProducts(); };
    $('type').onchange = () => { state.typeId = $('type').value; state.offset = 0; loadProducts(); };
    $('btn-export-products').onclick = () => { window.open(state.apiBase + '/export/products.csv', '_blank'); };

    // --- Edit modal ---
    function openEdit(id){
      const p = state.products.find(x=>x.id===id);
      if(!p){ alert('Producto no encontrado'); return; }
      state.selected = p;
      $('m-code').textContent = p.id_code;
      $('m-description').value = p.description || '';
      $('m-unit-cost').value = p.unit_cost ?? '';
      $('m-min').value = p.min_stock ?? '';
      $('m-max').value = p.max_stock ?? '';
      show($('modal-backdrop'), true);
    }
    $('m-cancel').onclick = () => show($('modal-backdrop'), false);
    $('m-save').onclick = async () => {
      if(!state.token){ alert('Requiere sesi贸n (admin)'); return; }
      const body = {
        description: $('m-description').value,
        unit_cost: $('m-unit-cost').value ? Number($('m-unit-cost').value) : null,
        min_stock: $('m-min').value ? Number($('m-min').value) : null,
        max_stock: $('m-max').value ? Number($('m-max').value) : null,
      };
      const res = await authedFetch('/products/' + state.selected.id, {method:'PATCH', body: JSON.stringify(body)});
      if(!res.ok){ alert('Error guardando'); return; }
      show($('modal-backdrop'), false);
      loadProducts();
    };

    // --- Discrepancies ---
    $('export-discrepancies').href = '#';
    $('export-discrepancies').onclick = (e)=>{
      e.preventDefault();
      window.open(state.apiBase + '/export/discrepancies.csv', '_blank');
    };

    async function loadDiscrepancies(){
      const res = await fetch(state.apiBase + '/discrepancies');
      if(!res.ok){ $('tbody-discrepancies').innerHTML = '<tr><td colspan="7">Error cargando discrepancias</td></tr>'; return; }
      const rows = await res.json();
      const tbody = $('tbody-discrepancies');
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td class="mono">${r.id_code}</td>
          <td>${r.description}</td>
          <td>${r.discrepancy_type}</td>
          <td>${r.detail}</td>
          <td class="right">${fmt(r.stock)}</td>
          <td class="right">${fmt(r.unit_cost ?? '')}</td>
          <td><button data-action="resolve" data-pid="${r.product_id}" data-type="${r.discrepancy_type}">Marcar resuelto</button></td>
        </tr>
      `).join('');
      tbody.querySelectorAll('button[data-action="resolve"]').forEach(btn=>{
        btn.onclick = async () => {
          if(!state.token){ alert('Requiere sesi贸n'); return; }
          const note = prompt('Nota (opcional):','');
          const body = { product_id:Number(btn.dataset.pid), discrepancy_type: btn.dataset.type, note };
          const res = await authedFetch('/discrepancies/resolve', { method:'POST', body: JSON.stringify(body) });
          if(res.ok){ loadDiscrepancies(); } else { alert('Error al resolver'); }
        };
      });
    }

    // Optional: stub function for history (to extend later)
    function showHistory(id){ alert('Historial todav铆a no implementado en la versi贸n plain.'); }

    // --- Bootstrap ---
    updateAuthUI();
    loadTypes();
    loadProducts();
    loadDiscrepancies();
  </script>
</body>
</html>
